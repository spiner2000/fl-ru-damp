<?php
require_once("../classes/config.php");

require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/sbr_adm.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/pskb.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/users.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/fpdf/fpdf.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/fpdf/fpdf_tpl.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/fpdi/fpdi.php");
require_once($_SERVER['DOCUMENT_ROOT'] . "/classes/CFile.php");

$res = array(
    'e' => array(),
    'a' => array(),
    's' => 0
);

/*
 идишники выгрузки с 01.01.2013 по 20.02.2013
 
 1018,1021,1071,1075,1086,1081,1094,1060,951,952,1042,1043,1054,1065,1080,1082,970,984,985,987,1009,1035,1044,1053,965,971,991,997,998,
 999,1000,1096,1100,1024,1031,1046,1048,975,980,993,995,1008,1011,1015,1016,1017,1004, 1910,1912,1911,1913
*/


/*
 идишники выгрузки с 01.03.2014 по 31.03.2014
 
 4435,4636,4357,4375,4359,4637,4651,4366,4392,4403,4365,4394,4402,4378,4384,4386,4393,4653,4654,4391,4397,4414,4382,4404,4405,4407,4396,4399,
 4400,4469,4472,4473,4485,4487,4361,4410,4362,4419,4425,4413,4424,4418,4417,4420,4422,4421,4423,4660,4664,4668,4461,4463,4433,4621,4538,4565,
 4568,4573,4591,4600,4610,4500,4509,4510,4521,4533,4584,4594,4595,4597,4599,4449,4454,4455,4464,4466,4451,4525,4669,4443,4477,4484,4491,4628,
 4638,4494,4465,4489,4492,4522,4529,4549,4553,4557,4558,4561,4563,4567,4363,4364,4439,4441,4456,4470,4475,4480,4506,4507,4514,4528,4493,4523,
 4536,4562,4579,4592,4602,4605,4609,4368,4488,4511,4512,4520,4588,4613,4643,4369,4490,4503,4370,4408,4479,4518,4526,4551,4560,4572,4589,4590,
 4598,4624,4371,4495,4501,4508,4517,4539,4570,4581,4583,4372,4376,4481,4498,4504,4524,4531,4532,4534,4540,4542,4546,4547,4548,4550,4552,4569,
 4574,4578,4535,4566,4571,4596,4645,4373,4499,4505,4513,4537,4541,4554,4555,4556,4559,4585,4608,4576,4580,4582,4586,4587,4593,4603,4607,4374,
 4428,4437,4467,4601,4604,4377,4398,4415,4431,4442,4486,4515,4516,4575,4606,4379,4395,4383,4388,4385,4427,4496,4355,4387,4430,4445,4453,4460,
 4497,4527,4530,4611,4612,4614,4356,4409,4436,4438,4440,4457,4471,4478,4482,4483,4502,4543,4577,4615,4617,4618,4619,4358,4367,4381,4389,4390,
 4406,4411,4412,4416,4426,4432,4434,4452,4458,4459,4468,4474,4360,4446,4447,4448,4450,4476,4544,4545,4616,4620,4622,4623,4626,4627,4629,4630,
 4639,4649,4656,4667,4673,4631,4634,4635,4642,4644,4652,4632,4640,4633,4672,4641,4646,4647,4648,4650,4655,4657,4658,4666,4670,4671,4659,4661,
 4662,4663,4665 
 
 */



/*

идишники выгрузки с 01.04.2014 по 30.04.2014

 4688,4772,4684,4686,4713,4689,4698,4704,4908,4695,4701,4707,4705,4780,4711,4719,4720,4721,4724,4718,4725,4729,4743,4745,4726,4727,4782,4734,
 4736,4741,4746,4737,4785,4739,4749,4753,4754,4750,4826,4832,4847,4848,4752,4761,4762,4763,4764,4767,4775,4781,4768,4769,4774,4777,4786,4783,
 4787,4794,4797,4784,4789,4796,4800,4802,4799,4805,4806,4803,4804,4817,4820,4902,4910,4914,4938,4808,4809,4810,4812,4814,4816,4822,4833,4825,
 4827,4678,4892,4913,4927,4933,4943,4677,4680,4692,4829,4843,4873,4879,4880,4881,4899,4901,4903,4904,4905,4906,4907,4915,4940,4944,4945,4830,
 4837,4840,4855,4867,4875,4876,4882,4885,4886,4887,4893,4894,4898,4919,4921,4931,4936,4948,4949,4679,4682,4694,4697,4834,4836,4838,4839,4841,
 4842,4844,4845,4846,4866,4869,4870,4874,4877,4883,4884,4890,4891,4681,4685,4702,4744,4747,4751,4755,4791,4792,4851,4852,4853,4854,4863,4864,
 4865,4868,4871,4872,4922,4924,4926,4941,4951,4687,4690,4696,4748,4793,4860,4861,4888,4889,4896,4897,4917,4918,4920,4925,4929,4932,4935,4952,
 4693,4710,4742,4756,4773,4835,4909,4912,4923,4757,4776,4798,4801,4818,4823,4824,4828,4831,4856,4916,4934,4939,4942,4950,4703,4715,4733,4738,
 4758,4766,4770,4807,4811,4815,4946,4953,4954,4955,4712,4717,4722,4723,4731,4732,4735,4759,4813,4857,4928,4947,4674,4675,4676,4691,4706,4709,
 4714,4730,4740,4760,4765,4778,4849,4850,4859,4895,4911

 */




/*

идишники выгрузки с 01.05.2014 по 31.05.2014

4991,4964,4967,4970,5004,5031,5028,5026,5064,4957,4959,4962,5047,5052,5083,5074,4961,4963,5067,5078,5080,4956,4958,4960,5061,5068,5079,5081,5082,
4965,4966,4976,4968,4969,4978,4972,4973,4974,4975,4977,4979,4980,4981,4982,4983,4984,4985,4986,4987,4988,4989,4990,4992,4993,4994,4995,4996,4997,
4999,5010,4998,5000,5034,5036,5054,5065,5076,5085,5086,5001,5002,5003,5012,5016,5021,5030,5037,5044,5045,5060,5005,5071,5075,5006,5007,5014,5015,
5017,5018,5024,5025,5033,5038,5048,5055,5063,5066,5073,5009,5011,5029,5035,5077,5013,5043,5046,5050,5051,5019,5049,5056,5059,5072,5020,5041,5042,
5022,5023,5027,5032,5039,5040,5053,5057,5058,5062,5069,5070,5084
 
 */







//идишники выгрузки с 01.04.2014 по 30.04.2014

$sql = "SELECT rr.*, s.id sbr_id, 
        CASE WHEN u.uid = s.emp_id THEN lc.\"tagCust\"+1 ELSE lc.\"tagPerf\"+1 END AS form_type
	    FROM pskb_invoice_raw rr 
        INNER JOIN users u ON u.login = rr.login
        LEFT JOIN pskb_lc lc ON lc.lc_id = rr.lc_id
        LEFT JOIN sbr s ON s.id = lc.sbr_id 
        WHERE 
        rr.status = 1 
        AND rr.id IN (
        
 4688,4772,4684,4686,4713,4689,4698,4704,4908,4695,4701,4707,4705,4780,4711,4719,4720,4721,4724,4718,4725,4729,4743,4745,4726,4727,4782,4734,
 4736,4741,4746,4737,4785,4739,4749,4753,4754,4750,4826,4832,4847,4848,4752,4761,4762,4763,4764,4767,4775,4781,4768,4769,4774,4777,4786,4783,
 4787,4794,4797,4784,4789,4796,4800,4802,4799,4805,4806,4803,4804,4817,4820,4902,4910,4914,4938,4808,4809,4810,4812,4814,4816,4822,4833,4825,
 4827,4678,4892,4913,4927,4933,4943,4677,4680,4692,4829,4843,4873,4879,4880,4881,4899,4901,4903,4904,4905,4906,4907,4915,4940,4944,4945,4830,
 4837,4840,4855,4867,4875,4876,4882,4885,4886,4887,4893,4894,4898,4919,4921,4931,4936,4948,4949,4679,4682,4694,4697,4834,4836,4838,4839,4841,
 4842,4844,4845,4846,4866,4869,4870,4874,4877,4883,4884,4890,4891,4681,4685,4702,4744,4747,4751,4755,4791,4792,4851,4852,4853,4854,4863,4864,
 4865,4868,4871,4872,4922,4924,4926,4941,4951,4687,4690,4696,4748,4793,4860,4861,4888,4889,4896,4897,4917,4918,4920,4925,4929,4932,4935,4952,
 4693,4710,4742,4756,4773,4835,4909,4912,4923,4757,4776,4798,4801,4818,4823,4824,4828,4831,4856,4916,4934,4939,4942,4950,4703,4715,4733,4738,
 4758,4766,4770,4807,4811,4815,4946,4953,4954,4955,4712,4717,4722,4723,4731,4732,4735,4759,4813,4857,4928,4947,4674,4675,4676,4691,4706,4709,
 4714,4730,4740,4760,4765,4778,4849,4850,4859,4895,4911

        ) ORDER BY sbr_id";






//идишники выгрузки с 01.03.2014 по 31.03.2014
/*
$sql = "SELECT rr.*, s.id sbr_id, 
        CASE WHEN u.uid = s.emp_id THEN lc.\"tagCust\"+1 ELSE lc.\"tagPerf\"+1 END AS form_type
	    FROM pskb_invoice_raw rr 
        INNER JOIN users u ON u.login = rr.login
        LEFT JOIN pskb_lc lc ON lc.lc_id = rr.lc_id
        LEFT JOIN sbr s ON s.id = lc.sbr_id 
        WHERE 
        rr.status = 1 
        AND rr.id IN (
        
 4435,4636,4357,4375,4359,4637,4651,4366,4392,4403,4365,4394,4402,4378,4384,4386,4393,4653,4654,4391,4397,4414,4382,4404,4405,4407,4396,4399,
 4400,4469,4472,4473,4485,4487,4361,4410,4362,4419,4425,4413,4424,4418,4417,4420,4422,4421,4423,4660,4664,4668,4461,4463,4433,4621,4538,4565,
 4568,4573,4591,4600,4610,4500,4509,4510,4521,4533,4584,4594,4595,4597,4599,4449,4454,4455,4464,4466,4451,4525,4669,4443,4477,4484,4491,4628,
 4638,4494,4465,4489,4492,4522,4529,4549,4553,4557,4558,4561,4563,4567,4363,4364,4439,4441,4456,4470,4475,4480,4506,4507,4514,4528,4493,4523,
 4536,4562,4579,4592,4602,4605,4609,4368,4488,4511,4512,4520,4588,4613,4643,4369,4490,4503,4370,4408,4479,4518,4526,4551,4560,4572,4589,4590,
 4598,4624,4371,4495,4501,4508,4517,4539,4570,4581,4583,4372,4376,4481,4498,4504,4524,4531,4532,4534,4540,4542,4546,4547,4548,4550,4552,4569,
 4574,4578,4535,4566,4571,4596,4645,4373,4499,4505,4513,4537,4541,4554,4555,4556,4559,4585,4608,4576,4580,4582,4586,4587,4593,4603,4607,4374,
 4428,4437,4467,4601,4604,4377,4398,4415,4431,4442,4486,4515,4516,4575,4606,4379,4395,4383,4388,4385,4427,4496,4355,4387,4430,4445,4453,4460,
 4497,4527,4530,4611,4612,4614,4356,4409,4436,4438,4440,4457,4471,4478,4482,4483,4502,4543,4577,4615,4617,4618,4619,4358,4367,4381,4389,4390,
 4406,4411,4412,4416,4426,4432,4434,4452,4458,4459,4468,4474,4360,4446,4447,4448,4450,4476,4544,4545,4616,4620,4622,4623,4626,4627,4629,4630,
 4639,4649,4656,4667,4673,4631,4634,4635,4642,4644,4652,4632,4640,4633,4672,4641,4646,4647,4648,4650,4655,4657,4658,4666,4670,4671,4659,4661,
 4662,4663,4665

        ) ORDER BY sbr_id";
*/



// выгрузка с 21.02.2013 по 25.04.2013
/*
$sql = "SELECT rr.*, s.id sbr_id, 
        CASE WHEN u.uid = s.emp_id THEN lc.\"tagCust\"+1 ELSE lc.\"tagPerf\"+1 END AS form_type
	    FROM pskb_invoice_raw rr 
        INNER JOIN users u ON u.login = rr.login
        LEFT JOIN pskb_lc lc ON lc.lc_id = rr.lc_id
        LEFT JOIN sbr s ON s.id = lc.sbr_id 
        WHERE 
        rr.status = 1 
        --AND sbr_id > 50842
        AND rr.id IN (

            2145,2147,2148,2149,2150,2151,2152,2153,2154,2155,2156,2157,2158,2159,2160,2162,2163,2164,2165,2166,2167,2168,2169,2170,2171,2172,2174,2175,
            2176,2177,2178,2179,2180,2181,2182,2183,2184,2185,2186,2187,2188,2189,2190,2191,2192,2193,2194,2196,2197,2200,2201,2202,2203,2205,2208,2211,
            2212,2213,2214,2215,2216,2217,2218,2219,2220,2221,2222,2223,2224,2225,2226,2227,2228,2229,2230,2231,2234,2235,2236,2237,2238,2240,2241,2242,
            2243,2244,2245,2246,2247,2248,2249,2250,2251,2252,2253,2254,2255,2256,2257,2259,2260,2261,2263,2264,2265,2266,2267,2268,2269,2271,2272,2273,
            2274,2275,2276,2277,2278,2279,2280,2281,2282,2283,2284,2285,2286,2287,2288,2289,2290,2291,2292,2293,2294,2295,2296,2297,2298,2299,2300,2301,
            2302,2303,2304,2305,2306,2307,2308,2309,2310,2311,2312,2313,2314,2315,2316,2317,2318,2319,2320,2321,2322,2323,2324,2325,2326,2327,2328,2330,
            2331,2332,2333,2334,2335,2336,2337,2338,2340,2341,2342,2343,2344,2345,2346,2347,2349,2350,2351,2352,2353,2355,2356,2357,2358,2359,2360,2361,
            2362,2363,2364,2366,2367,2368,2369,2370,2371,2372,2373,2374,2375,2376,2377,2378,2379,2380,2381,2382,2383,2384,2385,2386,2387,2388,2389,2390,
            2391,2392,2393,2394,2395,2396,2397,2398,2399,2400,2401,2402,2403,2404,2405,2406,2407,2408,2409,2410,2411,2412,2416

        ) ORDER BY sbr_id";
*/



$data = $DB->rows($sql);

//$sbr = sbr_meta::getInstance( sbr_meta::ADMIN_ACCESS );
$sbr = new sbr_adm(103, 'admin');

if($data) {
	foreach($data as $row) {
		$user = new users;
        $user->GetUser($row['login']);
        
        $letter = array();
        $letter['title'] = "СБР-{$row['sbr_id']}-Б/О#{$row['lc_id']}";
        $letter['user_add'] = 57748;
        $letter['user_1'] = 6;
        $letter['user_2'] = $user->uid;
        $letter['user_status_2'] = 11;

        $recipient = sbr_meta::getUserReqvs($letter['user_2']);
        if ( $row['form_type'] == 1 ) {
            $address = (bool) trim($recipient[1]['address']);
        } else {
            $address = (bool) trim($recipient[2]['address']) || (bool) trim($recipient[2]['address_fct']) || (bool) trim($recipient[2]['address_jry']);
        }
        if ( empty($address) ) {
            $res['a'][] = $row['sbr_id'];
            echo "{$row['sbr_id']} - Havn't address!\n";
            continue;
        }

		$sbr->initFromId($row['sbr_id']);

        //$letter['user1_i']['form_type']==1 ? $letter['user1_i'][1]['address'] : $letter['user1_i'][2]['address']
        
		/*
		$pdf_f_name = "/tmp/" . uniqid().".pdf";
		$recipient = sbr_meta::getUserReqvs($letter['user_2']);
        $user = new users();
        $user->GetUserByUID($letter['user_2']);
        $user_name = ($recipient['form_type']==1 ? $recipient[1]['fio'] : $recipient[2]['full_name']);
        $address =  ($recipient['form_type']==1 ? $recipient[1]['index'] : $recipient[2]['index']).", ".
			    	($recipient['form_type']==1 ? $recipient[1]['country'] : $recipient[2]['country']).", ".
					($recipient['form_type']==1 ? $recipient[1]['city'] : $recipient[2]['city']).", ".
					($recipient['form_type']==1 ? $recipient[1]['address'] : $recipient[2]['address']);
		$pdf = new FPDF('L', 'mm', 'A4');
		$pdf->AddFont('TimesNewRomanPSMT','','5f37f1915715e014ee2254b95c0b6cab_times.php');
		$pdf->SetFont('TimesNewRomanPSMT','',12);
		$pdf->SetTextColor(0,0,0);

		$pdf->AddPage('L');
		$pdf->SetXY(197,145);
		$pdf->SetDrawColor(50,60,100);
		$pdf->MultiCell(65,6,"Кому: ".html_entity_decode($user_name)."\nКуда: ".html_entity_decode($address),0,'L');
		$pdf->Output($pdf_f_name, "F");
		*/

		$pdf_name = "/tmp/" . uniqid().".pdf";
		$pdf = new FPDI();
		$pagecount = 1;

		/*
		$pagecount = $pdf->setSourceFile($pdf_f_name);
		$tplidx = $pdf->importPage($pagecount, '/MediaBox');
		$pdf->addPage('L');
		$pdf->useTemplate($tplidx, 0, 0);
		*/

		$save = true;
        $access = is_emp($user->role)? 2: 1;
        $fnames = array();
        $count_docs = 0;
        
        //foreach($sbr->getStages() as $stage) { 
        $doc_act = $DB->rows("select * from sbr_docs where is_deleted <> true AND sbr_id = ?", $row['sbr_id']);
        
		//	$doc_act = $sbr->getDocs(NULL, NULL, true, $stage->id, true);
			if($doc_act) {
                $fnames = array();
                $docs   = array();
				foreach ($doc_act as $doc) {
					if($doc['id']==$doc['first_doc_id'] || $doc['access_role'] != $access || preg_match("/^Акт по договору/", $doc['name'])) continue;
					
                    if($doc['type']=='2' || $doc['type']=='20480') {
                    	$cfile = new CFile($doc['file_id']);
                        if ( in_array($doc['name'] . ':::' . $cfile->size, $docs) ) {
                            continue;
                        }
                        if ( in_array($cfile->name, $fnames) ) {
                            continue;
                        }
                        $docs[] = $doc['name'] . ':::' . $cfile->size; // нужно переделать на хеш файла
                        $fnames[] = $cfile->name;
                        $p = pathinfo($cfile->name);
                        if ( strtolower($p['extension']) != 'pdf' ) {
                            $save = false;
                            break;
                        }
                        
                        $count_docs++;
                    	$tmp_name = "/tmp/" . uniqid().".pdf";
                    	file_put_contents($tmp_name, file_get_contents(WDCPREFIX . '/' . $cfile->path . $cfile->name));

						$pagecount = $pdf->setSourceFile($tmp_name);
						$tplidx = $pdf->importPage($pagecount, '/MediaBox');
						if(preg_match("/^Счет-фактура/",$doc['name'])) {
							$pdf->addPage('L');
						} else {
							$pdf->addPage('P');
						}
						$pdf->useTemplate($tplidx, 0, 0);

						if($doc['type']=='20480') {
							$pagecount = $pdf->setSourceFile($tmp_name);
							$tplidx = $pdf->importPage($pagecount, '/MediaBox');
							$pdf->addPage('P');
							$pdf->useTemplate($tplidx, 0, 0);
						}
					}
				}
                if ( !$save ) {
                    break;
                }
			}
		//}

		if ( $save && $count_docs) {

            $sql = "INSERT INTO letters(
                                            title,
                                            user_add,
                                            user_1,
                                            user_2,
                                            user_status_2,
                                            date_add,
                                            date_change_status,
                                            is_user_1_company,
                                            delivery
                                        ) VALUES (
                                            ?,
                                            ?i,
                                            ?i,
                                            ?i,
                                            ?i,
                                            NOW(),
                                            NOW(),
                                            't',
                                            1
                                        ) RETURNING id";
            $letter['id'] = $DB->val($sql, $letter['title'], $letter['user_add'], $letter['user_1'], $letter['user_2'], $letter['user_status_2']);

            
            $pdf->Output($pdf_name, 'F');				

            $cfile = new CFile(array('tmp_name'=>$pdf_name, 'name'=>$pdf_name, 'size'=>filesize($pdf_name)));
            $cfile->server_root = 1;
            $cfile->max_size = 5000000;
            $cfile->MoveUploadedFile('letters/');

            $sql = "UPDATE letters SET file_id = ?i WHERE id = ?i";
            $DB->query($sql, $cfile->id, $letter['id']);
            $res['s']++;
            echo "{$row['sbr_id']} - OK\n";
        } else {
            $res['e'][] = $row['sbr_id'];
            echo "{$row['sbr_id']} - PDF Convert Error!\n";
        }

	}
}

echo "-- Haven't address -------------------------------------\n";
foreach ( $res['a'] as $r ) {
    echo $r . "\n";
}
echo "-- PDF Conver Error ------------------------------------\n";
foreach ( $res['e'] as $r ) {
    echo $r . "\n";
}
echo "--------------------------------------------------------\n";
echo 'Success: ' . $res['s'] . '; Address Error: ' . count($res['a']) . '; PDF Error: ' . count($res['e']);

